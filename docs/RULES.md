# ポーカー（テキサスホールデム）実装用ルール定義書

## 1. ゲームの基本構成

* **使用カード**: ジョーカーを除いた52枚の標準的なトランプデッキ。
* **プレイヤー人数**: 2名（ヘッズアップ）から最大10名。
* **勝敗決定**: ショーダウン時に最も強い役を持つプレイヤー、または他の全員がフォールドした際の生存プレイヤーがポットを獲得する。

## 2. 役の強さ（ハンドランク）

強度の高い順に以下の通り定義する。

1. **ロイヤルフラッシュ**: 同じスートの ** A, K, Q, J, 10 **
2. **ストレートフラッシュ**: 同じスートで数字が連続する5枚。
3. **フォー・オブ・ア・カインド（クワッズ）**: 同じ数字が4枚。
4. **フルハウス**: 同じ数字3枚と、別の同じ数字2枚の組み合わせ。
5. **フラッシュ**: 同じスートが5枚。
6. **ストレート**: 数字が5枚連続する（スートは問わない）。 ** A ** は最上位（ ** A-K-Q-J-10 ** ）または最下位（ ** 5-4-3-2-A ** ）として機能する。
7. **スリー・オブ・ア・カインド（セット/トリップス）**: 同じ数字が3枚。
8. **ツーペア**: 同じ数字2枚の組が2つ。
9. **ワンペア**: 同じ数字2枚の組が1つ。
10. **ハイカード**: 上記の役が一つも成立していない場合、最も高い数字のカード。

## 3. ゲームの進行（フェーズ）

### ベッティングラウンドの共通ルール

各ラウンドは、以下のいずれかの条件が満たされるまで継続します。

1. **生存している全プレイヤーの場に出したチップ額が一致したとき**（かつ、全員がアクションを完了している）。
2. **一人のプレイヤーを除いて全員がフォールドしたとき**（その時点でそのプレイヤーの勝利となり、以降のラウンドはスキップ）。

### A. プリフロップ (Pre-flop)

コミュニティカードが0枚の状態です。

* **強制ベット**: ディーラーボタン（BTN）の左隣が**SB**、その左隣が**BB**を支払います。
* **カード配布**: 各プレイヤーに2枚ずつ配られます。
* **アクション開始**: **BBの左隣のプレイヤー（Under the Gun: UTG）**から時計回りに開始します。
* **選択肢**:
  * **フォールド**
  * **コール**（**BB**と同額を出す）
  * **レイズ**（**BB**の2倍以上の額を出す）

* **特記事項**: 全員がコールで回ってきた場合、最後に**BB**のプレイヤーが**チェック**（現状維持）か**レイズ**を選択してラウンドを終了させます。

### B. フロップ (Flop)

3枚のコミュニティカードが場に公開されます。

* **アクション開始**: **BTNのすぐ左側にいる生存プレイヤー**（通常は**SB**）から時計回りに開始します。
* **選択肢（誰もベットしていない場合）**:
  * **チェック**（チップを出さずに次の人へ）
  * **ベット**（最初にチップを出す）

* **選択肢（誰かがベットした後の場合）**:
  * **フォールド**
  * **コール**（最新のベット額に合わせる）
  * **レイズ**（最新のベット額に対して上乗せする）

* **ラウンドの終了**: 全員のベット額が揃うまで時計回りに進行します。全員が**チェック**で回った場合は、チップを動かさずに次のラウンドへ進みます。

### C. ターン (Turn)

4枚目のコミュニティカードが場に公開されます。

* アクション順はフロップと同様（BTNの左隣の生存プレイヤーから開始）。
* 選択肢もフロップと同様。

### D. リバー (River)

5枚目のコミュニティカードが場に公開されます。

* アクション順はフロップと同様（BTNの左隣の生存プレイヤーから開始）。
* 選択肢もフロップと同様。
* 最終のアクションを行います。

### E. ショーダウン (Showdown)

* 全アクション終了後、生存プレイヤーがカードを公開し、勝者を決定します。

## 4. プレイヤーのアクション

### 4.1 アクションの種類

* **フォールド (Fold)**: ハンドを捨て、その回のゲームを降りる。ベットしたチップは失われる。
  * **重要**: 自分がチップを追加しなくてもコールできる時（つまり、チェックできる時）はフォールドできない
  * フォールドできるのは、コールするために追加のチップが必要な場合のみ
* **チェック (Check)**: ベットせず、次のプレイヤーに手番を回す（既にベットが発生している場合は不可）。
* **コール (Call)**: 現在の最大ベット額と同額を出す。ベットが発生している場合のみ可能。
* **ベット (Bet)**: そのラウンドで最初にチップを出す。ベットが発生していない場合のみ可能。
* **レイズ (Raise)**: 前のプレイヤーのベット額に対し、さらに上乗せして出す。ベットが発生している場合のみ可能。
* **オールイン (All-in)**: 所持している全チップを賭ける。どの状況でも可能。

### 4.2 アクションの順序

* **時計回り**: アクションは時計回りに順番に進行する
* **スキップ**: フォールドまたはオールインしたプレイヤーはスキップされる
* **アクションの必須性**: 自分のターンが来た場合、必ずアクションを取る必要がある（フォールド、チェック、コール、ベット、レイズ、オールインのいずれか）

## 5. ベッティングルール（ノーリミット）

### 5.1 最小レイズ額の計算

* **基本ルール**: そのラウンドにおける直前のレイズ幅以上でレイズする必要がある。
* **計算方法**: 
  * 最小レイズ額 = max(現在のベット額 + 直前のレイズ幅, 現在のベット額 × 2)
  * 例1: BB=$10の場合、最初のレイズは最低$20（$10の2倍）
  * 例2: 誰かが$20にレイズした場合、次のレイズは最低$30（$20 + $10のレイズ幅）または$40（$20の2倍）のどちらか大きい方
* **レイズ幅の追跡**: 各ベッティングラウンドで、直前のレイズ幅を追跡する。プリフロップでは、ビッグブラインドが最初のレイズ幅となる。

### 5.2 その他のベッティングルール

* **オールイン (All-in)**: 所持している全チップを賭ける。
* **サイドポット**: 特定のプレイヤーがオールインし、他のプレイヤーがさらに賭けを続けた場合、オールインしたプレイヤーが関与できないサイドポットが形成される。

## 6. アルゴリズム実装時の注意点

* **勝敗判定**: 7枚（手札2枚＋場札5枚）から最高の5枚を選出するロジックを実装すること。
* **キッカー**: 同じ役（ワンペアなど）の場合、残りのカード（キッカー）の強さで勝敗を決める。
* **スプリットポット**: 役とキッカーが完全に同等の場合、ポットを等分する。

## 7. ベッティングラウンドの完了条件（重要）

### 7.1 最後のレイザーを追跡する仕組み

**基本原則**: レイズした人以外の全員に順番を回す必要がある。

#### `last_raiser_index`の追跡
- ベット、レイズ、オールイン（ベット額を上げる場合）のたびに、そのプレイヤーのインデックスを`last_raiser_index`に記録する
- レイズが発生するたびに**上書き更新**する（後からレイズした人を基準にする）
- 新しいベッティングラウンド開始時は`None`にリセット

#### 完了判定の基準位置
- レイズが発生した場合: `completion_index = last_raiser_index`（最後にレイズした人）
- レイズが発生していない場合: `completion_index = betting_round_start_index`（ラウンド開始位置）

#### 完了条件
以下の3つが全て満たされた時に完了:
1. 全アクティブプレイヤーのベットが一致している
2. 次のプレイヤー（current_player_index）が completion_index に戻ってきた
3. プリフロップの場合、BBがアクションを取っている（ブラインドポストだけでは不十分）

### 7.2 プリフロップの完了条件

**初期設定**:
- `betting_round_start_index = BB のインデックス`（dealer + 2）
- `last_raiser_index = BB のインデックス`（BBがブラインドをポストしているため、初期レイザーとして扱う）
- `bb_has_acted_preflop = False`

**完了条件**:
1. 全アクティブプレイヤーのベットが一致している
2. `current_player_index == completion_index`（最後のレイザー、または誰もレイズしていなければBB）
3. `bb_has_acted_preflop == True`（BBがアクションを取った）

**動作例**:
* **ケース1: SB raise → BB call**
  - SB レイズ → `last_raiser_index = SB`
  - BB コール → `bb_has_acted_preflop = True`
  - 次のプレイヤーに移動 → SB に戻る
  - `current_player_index == last_raiser_index (SB)` → **完了、フロップへ**

* **ケース2: UTG raise → CO reraise → BTN call → UTG call → CO に戻る**
  - UTG レイズ → `last_raiser_index = UTG`
  - CO リレイズ → `last_raiser_index = CO`（上書き更新）
  - BTN コール
  - UTG コール
  - 次のプレイヤーに移動 → CO に戻る
  - `current_player_index == last_raiser_index (CO)` → **完了、フロップへ**

* **ケース3: 全員リンプ（誰もレイズしない）**
  - 全員コール → `last_raiser_index = BB`（初期値のまま）
  - BB に戻る → BBがチェックまたはレイズを選択
  - BBがチェック → `bb_has_acted_preflop = True`
  - 次のプレイヤーに移動 → BB に戻る
  - `current_player_index == last_raiser_index (BB)` → **完了、フロップへ**

### 7.3 フロップ以降（フロップ、ターン、リバー）の完了条件

**初期設定**:
- `betting_round_start_index = ディーラーの左隣のインデックス`（dealer + 1、通常はSB）
- `last_raiser_index = None`（各ラウンド開始時にリセット）

**完了条件**:
1. 全アクティブプレイヤーのベットが一致している
2. `current_player_index == completion_index`
   - レイズがあった場合: 最後のレイザーに戻った
   - レイズがない場合: 開始位置（dealer + 1）に戻った

**動作例**:
* **ケース1: SB check → BB bet → SB call**
  - SB チェック → `last_raiser_index = None`（そのまま）
  - BB ベット → `last_raiser_index = BB`
  - SB コール
  - 次のプレイヤーに移動 → BB に戻る
  - `current_player_index == last_raiser_index (BB)` → **完了、次のラウンドへ**

* **ケース2: SB bet → BB raise → SB call**
  - SB ベット → `last_raiser_index = SB`
  - BB レイズ → `last_raiser_index = BB`（上書き更新）
  - SB コール
  - 次のプレイヤーに移動 → BB に戻る
  - `current_player_index == last_raiser_index (BB)` → **完了、次のラウンドへ**

* **ケース3: 全員チェック**
  - 全員チェック → `last_raiser_index = None`（そのまま）
  - 開始位置（SB）に戻る
  - `current_player_index == betting_round_start_index (SB)` → **完了、次のラウンドへ**

### 7.4 ベッティングラウンドの進行フロー

1. **アクションの開始**: 各ラウンドで決められた開始位置からアクションが始まる
2. **アクションの進行**: 時計回りに順番にアクションを取る（フォールド/オールインしたプレイヤーはスキップ）
3. **ベットの一致**: 全アクティブプレイヤーが同じ額をベットするまで続く
4. **最後のレイザーに戻る**: レイズがあった場合、最後にレイズした人に戻った時点で完了
5. **次のフェーズへ**: ベッティングラウンドが完了すると、次のフェーズ（フロップ、ターン、リバー、ショーダウン）に進む

### 7.5 特殊なケース

* **全員フォールド**: 1人を除いて全員がフォールドした場合、その時点でハンドが完了する
* **全員オールイン**: 2人以上のプレイヤーがオールインし、他のアクティブプレイヤーがいない場合、その時点でハンドが完了する
* **連続レイズ**: 誰かがレイズした後、他のプレイヤーがリレイズした場合、**リレイズした人が新しい基準**となり、全員がその人に対してアクションを取る必要がある

## 8. 実装時に定義すべきアクションの流れ（ロジック用）

実装を依頼する際は、以下のステップを意識させると正確なコードが書けます。

### 8.1 現在の手番プレイヤー (Current Player) の特定
* アクティブなプレイヤーの中で、現在アクションを取るべきプレイヤーを特定する
* フォールド/オールインしたプレイヤーはスキップする

### 8.2 可能なアクション (Legal Moves) の抽出
* **前のプレイヤーがベットしているか？**
  * Yes → チェック不可、フォールド/コール/レイズ/オールインが可能
  * No → チェック/ベット/オールインが可能
* **現在のベット額と自分のベット額の関係**
  * `player.bet >= current_bet` → チェック可能、フォールド不可
  * `player.bet < current_bet` → フォールド/コール/レイズ/オールインが可能

### 8.3 アクション実行後のポット合計と残チップの更新
* プレイヤーのスタックからベット額を減算
* ポットにベット額を加算
* プレイヤーのベット額を更新
* 現在のベット額を更新（レイズ/ベット/オールインの場合）
* **重要**: ベット額が上がった場合は`last_raiser_index`を更新

### 8.4 ラウンド終了判定
* **全員の賭け金が一致しているか？**
  * `all(p.bet == current_bet for p in active_players)`
* **最後にレイズした人に順番が戻ってきたか？**
  * `current_player_index == completion_index`
  * `completion_index = last_raiser_index`（レイズがあった場合）
  * `completion_index = betting_round_start_index`（レイズがない場合）
* **プリフロップの場合: BBがアクションを取ったか？**
  * `bb_has_acted_preflop == True`（BBが基準位置の場合のみチェック）

### 8.5 実装時の必須状態変数
* **`last_raiser_index`**: 最後にレイズ/ベットした人のインデックス（Noneまたは整数）
* **`betting_round_start_index`**: ベッティングラウンドの開始位置（整数）
* **`bb_has_acted_preflop`**: プリフロップでBBがアクションを取ったか（Boolean）
* **`last_raise_size`**: 直前のレイズ幅（整数、最小レイズ額計算用）
* **`current_bet`**: 現在のベット額（整数）

## 9. ゲームの自動進行

* 1ゲームが終了（FINISHEDフェーズ）した後、2秒後に自動的に次のゲームを開始する。

